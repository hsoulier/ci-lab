name: PR
run-name: PR ${{ github.ref_name }}
on:
  pull_request:
    types: [opened, reopened, synchronize, review_requested]

jobs:
  Prepare:
    runs-on: ubuntu-latest
    steps:
      - name: 🤝 List caches in the repo
        id: list-cache
        run: gh cache list --repo $REPO | grep -e "build-nextjs" > out.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
      - name: 👀 Sort clearable caches
        run: cat out.txt | grep -e "build-nextjs" | cut -b 1-3 >> to-delete.txt
      - name: 🧹 Clean caches in the repo
        run: while read in; do gh cache delete "$in" --repo hsoulier/ci-lab; done < to-delete.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # uses: ./.github/workflows/base.yml
  Build:
    needs: Prepare
    uses: ./.github/workflows/build.yml
  Deploy:
    needs: Build
    uses: ./.github/workflows/test.yml
  Clean:
    runs-on: ubuntu-latest
    needs: Deploy
    steps:
      - name: 🤝 List caches inthe repo
        id: list-cache
        run: gh cache list --repo $REPO | grep -e "build-nextjs"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
      - name: 👀 Sort clearable caches
        run: "${{steps.list-cache.outputs}} | grep -e 'build-nextjs' | cut -b 1-3"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 🧹 Clean caches in the repo
        run: "${{steps.list-cache.outputs}} | xargs -L1 gh cache delete"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
